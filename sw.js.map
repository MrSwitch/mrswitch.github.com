{"version":3,"sources":["node_modules/browser-pack/_prelude.js","src/indexdb.js","src/sw.js"],"names":[],"mappings":"AAAA;ACAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACpIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"sw.js","sourcesContent":["(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})","// indexStorage\n// This wraps an interface around IndexDB to create an object store\n\n// Create an instance of the db\n// The Cache name is optional, it will allow us to group various datasets (the default is __tricks__)\n\nclass DB {\n\tconstructor (name, version, schema) {\n\n\t\t// Define the schema to use in the connection\n\t\tthis.db_name = name || '__tricks__';\n\t\tif (typeof version === 'object') {\n\t\t\tthis.version = 1;\n\t\t\tthis.schema = version;\n\t\t}\n\t\telse {\n\t\t\tthis.version = version || 1;\n\t\t\tthis.schema = schema;\n\t\t}\n\t\tthis.table_name = '__tricks__';\n\n\t\t// Return a function\n\t\treturn Object.assign(this.scope.bind(this), this);\n\t}\n\n\tscope (name) {\n\t\t// Create a new store instance\n\t\tconst inst = Object.create(this);\n\t\tinst.table_name = name;\n\t\treturn inst;\n\t}\n\n\topen(mode) {\n\t\treturn new Promise((accept, reject) => {\n\t\t\tconst db = self.indexedDB.open(this.db_name, this.version);\n\t\t\tdb.onsuccess = event => {\n\t\t\t\taccept(event.target.result);\n\t\t\t};\n\t\t\tdb.onerror = reject;\n\t\t\tdb.onupgradeneeded = event => {\n\t\t\t\tconst db = event.target.result;\n\n\t\t\t\t// this should probably do something;\n\t\t\t\tfor (const x in this.schema) {\n\t\t\t\t\tif (!db.objectStoreNames.contains(x)) {\n\t\t\t\t\t\tdb.createObjectStore(x, this.schema[x]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\t\t})\n\t\t.then(db => {\n\t\t\t// The DB connection has been established\n\t\t\t// Lets create a connection to it\n\t\t\tconst transaction = db.transaction([this.table_name], mode);\n\n\t\t\t// Return the API for the Object Store\n\t\t\treturn transaction.objectStore(this.table_name);\n\t\t});\n\t}\n\n\tget (key) {\n\n\t\t// We've got all the information to make a request to IndexDB\n\t\treturn new Promise((accept, reject) => {\n\t\t\tthis.open().then(objectStore => {\n\t\t\t\t// Find items in this table by Key\n\t\t\t\tconst request = objectStore.get(key);\n\t\t\t\trequest.onsuccess = event => {\n\t\t\t\t\taccept(event.target.result);\n\t\t\t\t};\n\t\t\t\trequest.onerror = event => {\n\t\t\t\t\treject(event.target.result);\n\t\t\t\t};\n\t\t\t});\n\t\t});\n\t}\n\n\tall () {\n\n\t\t// We've got all the information to make a request to IndexDB\n\t\treturn new Promise((accept, reject) => {\n\t\t\tthis.open().then(objectStore => {\n\t\t  // Find items in this table by Key\n\t\t\t\tconst request = objectStore.openCursor();\n\t\t\t\trequest.onerror = event => {\n\t\t\t\t\treject(event.target.result);\n\t\t\t\t};\n\n\t\t\t\tconst a = [];\n\t\t\t\trequest.onsuccess = event => {\n\t\t\t\t\tconst cursor = event.target.result;\n\t\t\t\t\tif (cursor) {\n\t\t\t\t\t\ta.push(cursor.value);\n\t\t\t\t\t\tcursor.continue();\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\taccept(a);\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t});\n\t\t});\n\t}\n\n\tput (key, data) {\n\n\t\treturn new Promise((accept, reject) => {\n\n\t\t\t// Allow data as a thing on its own.\n\t\t\tif (typeof key === 'object') {\n\t\t\t\tdata = key;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdata.key = key;\n\t\t\t}\n\n\t\t\t// Open up a connection to indexdb\n\t\t\tthis.open('readwrite').then(objectStore => {\n\t\t\t\tconst request = objectStore.put(data);\n\t\t\t\trequest.onsuccess = event => {\n\t\t\t\t\taccept(event.target.result);\n\t\t\t\t};\n\t\t\t\trequest.onerror = event => {\n\t\t\t\t\treject(event.target.result);\n\t\t\t\t};\n\t\t\t})\n\t\t\t.catch(reject);\n\n\t\t});\n\t}\n}\n\nmodule.exports = DB;\n","// Service Worker\n// Caches pages visited by agent for viewing offline\n\nconst CACHE_NAME = 'adodson_sw';\nconst VERSION = 1;\n\nconst DB = require('./indexdb');\nconst db = new DB('adodson_sw', VERSION, {\n\tfalloverStore: {\n\t\tautoIncrement: true\n\t}\n});\n\nconst falloverStore = db('falloverStore');\n\nself.addEventListener('install', event => {\n\t// Perform install steps\n\tevent.waitUntil(\n\t\tcaches.open(CACHE_NAME).then(() => {\n\t\t\t// Opened cache\n\t\t})\n\t);\n});\n\nself.addEventListener('fetch', event => {\n\tconst request = event.request;\n\n\tevent.respondWith(promiseAny([\n\t\tcaches.match(request)\n\t\t\t.then(b => {\n\t\t\t\tif (!b) throw \"Not in cache\";\n\t\t\t\tconsole.log('Cache wins', request.url);\n\t\t\t\treturn b;\n\t\t\t}),\n\t\tfetch(request)\n\t\t\t.then(b => {\n\t\t\t\tif (!b) throw \"No access via network\";\n\t\t\t\tconsole.log('network wins', request.url);\n\t\t\t\treturn b;\n\t\t\t})\n\t\t\t.then(cacheUpdate.bind(null, request))\n    ]).catch(offlineFallback.bind(null, request)));\n});\n\n\nfunction promiseAny(promises) {\n\treturn new Promise((resolve, reject) => {\n\t\t// make sure promises are all promises\n\t\tpromises = promises.map(p => Promise.resolve(p));\n\t\t// resolve this promise as soon as one resolves\n\t\tpromises.forEach(p => p.then(resolve));\n\t\t// reject if all promises reject\n\t\tpromises\n\t\t.reduce((a, b) => a.catch(() => b))\n\t\t.catch(() => reject(Error(\"All failed\")));\n\t});\n};\n\nfunction cacheUpdate(request, response) {\n\n\t// Check if we received a valid response\n\tif (!response || response.status !== 200 || response.type !== 'basic') {\n\t\treturn response;\n\t}\n\n\tconst responseToCache = response.clone();\n\n\tcaches.open(CACHE_NAME).then(cache => {\n\t\tcache.put(request, responseToCache);\n\t});\n\n\treturn response;\n}\n\nfunction offlineFallback(request) {\n\n\treturn falloverStore.all().then(fallover => {\n\n\t\tconst match = fallover.filter(item => (\n\t\t\t(!item.mode || item.mode === request.mode)\n\t\t\t&& (!item.url || request.url.match(item.url))\n\t\t))[0];\n\n\t\tif (match) {\n\t\t\treturn caches.match(new Request(match.fallover));\n\t\t}\n\n\t\treturn;\n\t});\n}\n\n\nself.addEventListener('message', event => {\n\n\tconst data = event.data;\n\n\t// Open cache for actions\n\tcaches.open(CACHE_NAME).then(cache => {\n\t\tswitch (data.type) {\n\n\t\t\tcase 'fallover': {\n\t\t\t\t// Has this already been added?\n\t\t\t\tfalloverStore.all().then(fallover => {\n\t\t\t\t\tconst match = fallover.filter(item => item.mode === data.mode && item.url === data.url)[0];\n\t\t\t\t\tif (match) {\n\t\t\t\t\t\t// does this need\n\t\t\t\t\t\tif (match.fallover === data.fallover) {\n\t\t\t\t\t\t\t// nothing to do\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tconst frequest = new Request(data.fallover, {mode: 'no-cors'});\n\n\t\t\t\t\tfetch(frequest).then(response => {\n\t\t\t\t\t\t// Just update the existing record\n\t\t\t\t\t\tif (match) {\n\t\t\t\t\t\t\tmatch.fallover = data.fallover;\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tfalloverStore.put(data);\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn cache.put(data.fallover, response);\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'add': {\n\t\t\t\tconst request = new Request(data.url, {mode: 'no-cors'});\n\t\t\t\treturn fetch(request).then(response => cache.put(data.url, response));\n\t\t\t}\n\t\t}\n\t});\n});\n\n\n"],"preExistingComment":"//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9icm93c2VyLXBhY2svX3ByZWx1ZGUuanMiLCJzcmMvaW5kZXhkYi5qcyIsInNyYy9zdy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQ0FBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ3BJQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJnZW5lcmF0ZWQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uIGUodCxuLHIpe2Z1bmN0aW9uIHMobyx1KXtpZighbltvXSl7aWYoIXRbb10pe3ZhciBhPXR5cGVvZiByZXF1aXJlPT1cImZ1bmN0aW9uXCImJnJlcXVpcmU7aWYoIXUmJmEpcmV0dXJuIGEobywhMCk7aWYoaSlyZXR1cm4gaShvLCEwKTt2YXIgZj1uZXcgRXJyb3IoXCJDYW5ub3QgZmluZCBtb2R1bGUgJ1wiK28rXCInXCIpO3Rocm93IGYuY29kZT1cIk1PRFVMRV9OT1RfRk9VTkRcIixmfXZhciBsPW5bb109e2V4cG9ydHM6e319O3Rbb11bMF0uY2FsbChsLmV4cG9ydHMsZnVuY3Rpb24oZSl7dmFyIG49dFtvXVsxXVtlXTtyZXR1cm4gcyhuP246ZSl9LGwsbC5leHBvcnRzLGUsdCxuLHIpfXJldHVybiBuW29dLmV4cG9ydHN9dmFyIGk9dHlwZW9mIHJlcXVpcmU9PVwiZnVuY3Rpb25cIiYmcmVxdWlyZTtmb3IodmFyIG89MDtvPHIubGVuZ3RoO28rKylzKHJbb10pO3JldHVybiBzfSkiLCIvLyBpbmRleFN0b3JhZ2Vcbi8vIFRoaXMgd3JhcHMgYW4gaW50ZXJmYWNlIGFyb3VuZCBJbmRleERCIHRvIGNyZWF0ZSBhbiBvYmplY3Qgc3RvcmVcblxuLy8gQ3JlYXRlIGFuIGluc3RhbmNlIG9mIHRoZSBkYlxuLy8gVGhlIENhY2hlIG5hbWUgaXMgb3B0aW9uYWwsIGl0IHdpbGwgYWxsb3cgdXMgdG8gZ3JvdXAgdmFyaW91cyBkYXRhc2V0cyAodGhlIGRlZmF1bHQgaXMgX190cmlja3NfXylcblxuY2xhc3MgREIge1xuXHRjb25zdHJ1Y3RvciAobmFtZSwgdmVyc2lvbiwgc2NoZW1hKSB7XG5cblx0XHQvLyBEZWZpbmUgdGhlIHNjaGVtYSB0byB1c2UgaW4gdGhlIGNvbm5lY3Rpb25cblx0XHR0aGlzLmRiX25hbWUgPSBuYW1lIHx8ICdfX3RyaWNrc19fJztcblx0XHRpZiAodHlwZW9mIHZlcnNpb24gPT09ICdvYmplY3QnKSB7XG5cdFx0XHR0aGlzLnZlcnNpb24gPSAxO1xuXHRcdFx0dGhpcy5zY2hlbWEgPSB2ZXJzaW9uO1xuXHRcdH1cblx0XHRlbHNlIHtcblx0XHRcdHRoaXMudmVyc2lvbiA9IHZlcnNpb24gfHwgMTtcblx0XHRcdHRoaXMuc2NoZW1hID0gc2NoZW1hO1xuXHRcdH1cblx0XHR0aGlzLnRhYmxlX25hbWUgPSAnX190cmlja3NfXyc7XG5cblx0XHQvLyBSZXR1cm4gYSBmdW5jdGlvblxuXHRcdHJldHVybiBPYmplY3QuYXNzaWduKHRoaXMuc2NvcGUuYmluZCh0aGlzKSwgdGhpcyk7XG5cdH1cblxuXHRzY29wZSAobmFtZSkge1xuXHRcdC8vIENyZWF0ZSBhIG5ldyBzdG9yZSBpbnN0YW5jZVxuXHRcdGNvbnN0IGluc3QgPSBPYmplY3QuY3JlYXRlKHRoaXMpO1xuXHRcdGluc3QudGFibGVfbmFtZSA9IG5hbWU7XG5cdFx0cmV0dXJuIGluc3Q7XG5cdH1cblxuXHRvcGVuKG1vZGUpIHtcblx0XHRyZXR1cm4gbmV3IFByb21pc2UoKGFjY2VwdCwgcmVqZWN0KSA9PiB7XG5cdFx0XHRjb25zdCBkYiA9IHNlbGYuaW5kZXhlZERCLm9wZW4odGhpcy5kYl9uYW1lLCB0aGlzLnZlcnNpb24pO1xuXHRcdFx0ZGIub25zdWNjZXNzID0gZXZlbnQgPT4ge1xuXHRcdFx0XHRhY2NlcHQoZXZlbnQudGFyZ2V0LnJlc3VsdCk7XG5cdFx0XHR9O1xuXHRcdFx0ZGIub25lcnJvciA9IHJlamVjdDtcblx0XHRcdGRiLm9udXBncmFkZW5lZWRlZCA9IGV2ZW50ID0+IHtcblx0XHRcdFx0Y29uc3QgZGIgPSBldmVudC50YXJnZXQucmVzdWx0O1xuXG5cdFx0XHRcdC8vIHRoaXMgc2hvdWxkIHByb2JhYmx5IGRvIHNvbWV0aGluZztcblx0XHRcdFx0Zm9yIChjb25zdCB4IGluIHRoaXMuc2NoZW1hKSB7XG5cdFx0XHRcdFx0aWYgKCFkYi5vYmplY3RTdG9yZU5hbWVzLmNvbnRhaW5zKHgpKSB7XG5cdFx0XHRcdFx0XHRkYi5jcmVhdGVPYmplY3RTdG9yZSh4LCB0aGlzLnNjaGVtYVt4XSk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHR9O1xuXHRcdH0pXG5cdFx0LnRoZW4oZGIgPT4ge1xuXHRcdFx0Ly8gVGhlIERCIGNvbm5lY3Rpb24gaGFzIGJlZW4gZXN0YWJsaXNoZWRcblx0XHRcdC8vIExldHMgY3JlYXRlIGEgY29ubmVjdGlvbiB0byBpdFxuXHRcdFx0Y29uc3QgdHJhbnNhY3Rpb24gPSBkYi50cmFuc2FjdGlvbihbdGhpcy50YWJsZV9uYW1lXSwgbW9kZSk7XG5cblx0XHRcdC8vIFJldHVybiB0aGUgQVBJIGZvciB0aGUgT2JqZWN0IFN0b3JlXG5cdFx0XHRyZXR1cm4gdHJhbnNhY3Rpb24ub2JqZWN0U3RvcmUodGhpcy50YWJsZV9uYW1lKTtcblx0XHR9KTtcblx0fVxuXG5cdGdldCAoa2V5KSB7XG5cblx0XHQvLyBXZSd2ZSBnb3QgYWxsIHRoZSBpbmZvcm1hdGlvbiB0byBtYWtlIGEgcmVxdWVzdCB0byBJbmRleERCXG5cdFx0cmV0dXJuIG5ldyBQcm9taXNlKChhY2NlcHQsIHJlamVjdCkgPT4ge1xuXHRcdFx0dGhpcy5vcGVuKCkudGhlbihvYmplY3RTdG9yZSA9PiB7XG5cdFx0XHRcdC8vIEZpbmQgaXRlbXMgaW4gdGhpcyB0YWJsZSBieSBLZXlcblx0XHRcdFx0Y29uc3QgcmVxdWVzdCA9IG9iamVjdFN0b3JlLmdldChrZXkpO1xuXHRcdFx0XHRyZXF1ZXN0Lm9uc3VjY2VzcyA9IGV2ZW50ID0+IHtcblx0XHRcdFx0XHRhY2NlcHQoZXZlbnQudGFyZ2V0LnJlc3VsdCk7XG5cdFx0XHRcdH07XG5cdFx0XHRcdHJlcXVlc3Qub25lcnJvciA9IGV2ZW50ID0+IHtcblx0XHRcdFx0XHRyZWplY3QoZXZlbnQudGFyZ2V0LnJlc3VsdCk7XG5cdFx0XHRcdH07XG5cdFx0XHR9KTtcblx0XHR9KTtcblx0fVxuXG5cdGFsbCAoKSB7XG5cblx0XHQvLyBXZSd2ZSBnb3QgYWxsIHRoZSBpbmZvcm1hdGlvbiB0byBtYWtlIGEgcmVxdWVzdCB0byBJbmRleERCXG5cdFx0cmV0dXJuIG5ldyBQcm9taXNlKChhY2NlcHQsIHJlamVjdCkgPT4ge1xuXHRcdFx0dGhpcy5vcGVuKCkudGhlbihvYmplY3RTdG9yZSA9PiB7XG5cdFx0ICAvLyBGaW5kIGl0ZW1zIGluIHRoaXMgdGFibGUgYnkgS2V5XG5cdFx0XHRcdGNvbnN0IHJlcXVlc3QgPSBvYmplY3RTdG9yZS5vcGVuQ3Vyc29yKCk7XG5cdFx0XHRcdHJlcXVlc3Qub25lcnJvciA9IGV2ZW50ID0+IHtcblx0XHRcdFx0XHRyZWplY3QoZXZlbnQudGFyZ2V0LnJlc3VsdCk7XG5cdFx0XHRcdH07XG5cblx0XHRcdFx0Y29uc3QgYSA9IFtdO1xuXHRcdFx0XHRyZXF1ZXN0Lm9uc3VjY2VzcyA9IGV2ZW50ID0+IHtcblx0XHRcdFx0XHRjb25zdCBjdXJzb3IgPSBldmVudC50YXJnZXQucmVzdWx0O1xuXHRcdFx0XHRcdGlmIChjdXJzb3IpIHtcblx0XHRcdFx0XHRcdGEucHVzaChjdXJzb3IudmFsdWUpO1xuXHRcdFx0XHRcdFx0Y3Vyc29yLmNvbnRpbnVlKCk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdGVsc2Uge1xuXHRcdFx0XHRcdFx0YWNjZXB0KGEpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fTtcblx0XHRcdH0pO1xuXHRcdH0pO1xuXHR9XG5cblx0cHV0IChrZXksIGRhdGEpIHtcblxuXHRcdHJldHVybiBuZXcgUHJvbWlzZSgoYWNjZXB0LCByZWplY3QpID0+IHtcblxuXHRcdFx0Ly8gQWxsb3cgZGF0YSBhcyBhIHRoaW5nIG9uIGl0cyBvd24uXG5cdFx0XHRpZiAodHlwZW9mIGtleSA9PT0gJ29iamVjdCcpIHtcblx0XHRcdFx0ZGF0YSA9IGtleTtcblx0XHRcdH1cblx0XHRcdGVsc2Uge1xuXHRcdFx0XHRkYXRhLmtleSA9IGtleTtcblx0XHRcdH1cblxuXHRcdFx0Ly8gT3BlbiB1cCBhIGNvbm5lY3Rpb24gdG8gaW5kZXhkYlxuXHRcdFx0dGhpcy5vcGVuKCdyZWFkd3JpdGUnKS50aGVuKG9iamVjdFN0b3JlID0+IHtcblx0XHRcdFx0Y29uc3QgcmVxdWVzdCA9IG9iamVjdFN0b3JlLnB1dChkYXRhKTtcblx0XHRcdFx0cmVxdWVzdC5vbnN1Y2Nlc3MgPSBldmVudCA9PiB7XG5cdFx0XHRcdFx0YWNjZXB0KGV2ZW50LnRhcmdldC5yZXN1bHQpO1xuXHRcdFx0XHR9O1xuXHRcdFx0XHRyZXF1ZXN0Lm9uZXJyb3IgPSBldmVudCA9PiB7XG5cdFx0XHRcdFx0cmVqZWN0KGV2ZW50LnRhcmdldC5yZXN1bHQpO1xuXHRcdFx0XHR9O1xuXHRcdFx0fSlcblx0XHRcdC5jYXRjaChyZWplY3QpO1xuXG5cdFx0fSk7XG5cdH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBEQjtcbiIsIi8vIFNlcnZpY2UgV29ya2VyXG4vLyBDYWNoZXMgcGFnZXMgdmlzaXRlZCBieSBhZ2VudCBmb3Igdmlld2luZyBvZmZsaW5lXG5cbmNvbnN0IENBQ0hFX05BTUUgPSAnYWRvZHNvbl9zdyc7XG5jb25zdCBWRVJTSU9OID0gMTtcblxuY29uc3QgREIgPSByZXF1aXJlKCcuL2luZGV4ZGInKTtcbmNvbnN0IGRiID0gbmV3IERCKCdhZG9kc29uX3N3JywgVkVSU0lPTiwge1xuXHRmYWxsb3ZlclN0b3JlOiB7XG5cdFx0YXV0b0luY3JlbWVudDogdHJ1ZVxuXHR9XG59KTtcblxuY29uc3QgZmFsbG92ZXJTdG9yZSA9IGRiKCdmYWxsb3ZlclN0b3JlJyk7XG5cbnNlbGYuYWRkRXZlbnRMaXN0ZW5lcignaW5zdGFsbCcsIGV2ZW50ID0+IHtcblx0Ly8gUGVyZm9ybSBpbnN0YWxsIHN0ZXBzXG5cdGV2ZW50LndhaXRVbnRpbChcblx0XHRjYWNoZXMub3BlbihDQUNIRV9OQU1FKS50aGVuKCgpID0+IHtcblx0XHRcdC8vIE9wZW5lZCBjYWNoZVxuXHRcdH0pXG5cdCk7XG59KTtcblxuc2VsZi5hZGRFdmVudExpc3RlbmVyKCdmZXRjaCcsIGV2ZW50ID0+IHtcblx0Y29uc3QgcmVxdWVzdCA9IGV2ZW50LnJlcXVlc3Q7XG5cblx0ZXZlbnQucmVzcG9uZFdpdGgocHJvbWlzZUFueShbXG5cdFx0Y2FjaGVzLm1hdGNoKHJlcXVlc3QpXG5cdFx0XHQudGhlbihiID0+IHtcblx0XHRcdFx0aWYgKCFiKSB0aHJvdyBcIk5vdCBpbiBjYWNoZVwiO1xuXHRcdFx0XHRjb25zb2xlLmxvZygnQ2FjaGUgd2lucycsIHJlcXVlc3QudXJsKTtcblx0XHRcdFx0cmV0dXJuIGI7XG5cdFx0XHR9KSxcblx0XHRmZXRjaChyZXF1ZXN0KVxuXHRcdFx0LnRoZW4oYiA9PiB7XG5cdFx0XHRcdGlmICghYikgdGhyb3cgXCJObyBhY2Nlc3MgdmlhIG5ldHdvcmtcIjtcblx0XHRcdFx0Y29uc29sZS5sb2coJ25ldHdvcmsgd2lucycsIHJlcXVlc3QudXJsKTtcblx0XHRcdFx0cmV0dXJuIGI7XG5cdFx0XHR9KVxuXHRcdFx0LnRoZW4oY2FjaGVVcGRhdGUuYmluZChudWxsLCByZXF1ZXN0KSlcbiAgICBdKS5jYXRjaChvZmZsaW5lRmFsbGJhY2suYmluZChudWxsLCByZXF1ZXN0KSkpO1xufSk7XG5cblxuZnVuY3Rpb24gcHJvbWlzZUFueShwcm9taXNlcykge1xuXHRyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXHRcdC8vIG1ha2Ugc3VyZSBwcm9taXNlcyBhcmUgYWxsIHByb21pc2VzXG5cdFx0cHJvbWlzZXMgPSBwcm9taXNlcy5tYXAocCA9PiBQcm9taXNlLnJlc29sdmUocCkpO1xuXHRcdC8vIHJlc29sdmUgdGhpcyBwcm9taXNlIGFzIHNvb24gYXMgb25lIHJlc29sdmVzXG5cdFx0cHJvbWlzZXMuZm9yRWFjaChwID0+IHAudGhlbihyZXNvbHZlKSk7XG5cdFx0Ly8gcmVqZWN0IGlmIGFsbCBwcm9taXNlcyByZWplY3Rcblx0XHRwcm9taXNlc1xuXHRcdC5yZWR1Y2UoKGEsIGIpID0+IGEuY2F0Y2goKCkgPT4gYikpXG5cdFx0LmNhdGNoKCgpID0+IHJlamVjdChFcnJvcihcIkFsbCBmYWlsZWRcIikpKTtcblx0fSk7XG59O1xuXG5mdW5jdGlvbiBjYWNoZVVwZGF0ZShyZXF1ZXN0LCByZXNwb25zZSkge1xuXG5cdC8vIENoZWNrIGlmIHdlIHJlY2VpdmVkIGEgdmFsaWQgcmVzcG9uc2Vcblx0aWYgKCFyZXNwb25zZSB8fCByZXNwb25zZS5zdGF0dXMgIT09IDIwMCB8fCByZXNwb25zZS50eXBlICE9PSAnYmFzaWMnKSB7XG5cdFx0cmV0dXJuIHJlc3BvbnNlO1xuXHR9XG5cblx0Y29uc3QgcmVzcG9uc2VUb0NhY2hlID0gcmVzcG9uc2UuY2xvbmUoKTtcblxuXHRjYWNoZXMub3BlbihDQUNIRV9OQU1FKS50aGVuKGNhY2hlID0+IHtcblx0XHRjYWNoZS5wdXQocmVxdWVzdCwgcmVzcG9uc2VUb0NhY2hlKTtcblx0fSk7XG5cblx0cmV0dXJuIHJlc3BvbnNlO1xufVxuXG5mdW5jdGlvbiBvZmZsaW5lRmFsbGJhY2socmVxdWVzdCkge1xuXG5cdHJldHVybiBmYWxsb3ZlclN0b3JlLmFsbCgpLnRoZW4oZmFsbG92ZXIgPT4ge1xuXG5cdFx0Y29uc3QgbWF0Y2ggPSBmYWxsb3Zlci5maWx0ZXIoaXRlbSA9PiAoXG5cdFx0XHQoIWl0ZW0ubW9kZSB8fCBpdGVtLm1vZGUgPT09IHJlcXVlc3QubW9kZSlcblx0XHRcdCYmICghaXRlbS51cmwgfHwgcmVxdWVzdC51cmwubWF0Y2goaXRlbS51cmwpKVxuXHRcdCkpWzBdO1xuXG5cdFx0aWYgKG1hdGNoKSB7XG5cdFx0XHRyZXR1cm4gY2FjaGVzLm1hdGNoKG5ldyBSZXF1ZXN0KG1hdGNoLmZhbGxvdmVyKSk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuO1xuXHR9KTtcbn1cblxuXG5zZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCBldmVudCA9PiB7XG5cblx0Y29uc3QgZGF0YSA9IGV2ZW50LmRhdGE7XG5cblx0Ly8gT3BlbiBjYWNoZSBmb3IgYWN0aW9uc1xuXHRjYWNoZXMub3BlbihDQUNIRV9OQU1FKS50aGVuKGNhY2hlID0+IHtcblx0XHRzd2l0Y2ggKGRhdGEudHlwZSkge1xuXG5cdFx0XHRjYXNlICdmYWxsb3Zlcic6IHtcblx0XHRcdFx0Ly8gSGFzIHRoaXMgYWxyZWFkeSBiZWVuIGFkZGVkP1xuXHRcdFx0XHRmYWxsb3ZlclN0b3JlLmFsbCgpLnRoZW4oZmFsbG92ZXIgPT4ge1xuXHRcdFx0XHRcdGNvbnN0IG1hdGNoID0gZmFsbG92ZXIuZmlsdGVyKGl0ZW0gPT4gaXRlbS5tb2RlID09PSBkYXRhLm1vZGUgJiYgaXRlbS51cmwgPT09IGRhdGEudXJsKVswXTtcblx0XHRcdFx0XHRpZiAobWF0Y2gpIHtcblx0XHRcdFx0XHRcdC8vIGRvZXMgdGhpcyBuZWVkXG5cdFx0XHRcdFx0XHRpZiAobWF0Y2guZmFsbG92ZXIgPT09IGRhdGEuZmFsbG92ZXIpIHtcblx0XHRcdFx0XHRcdFx0Ly8gbm90aGluZyB0byBkb1xuXHRcdFx0XHRcdFx0XHRyZXR1cm47XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdGNvbnN0IGZyZXF1ZXN0ID0gbmV3IFJlcXVlc3QoZGF0YS5mYWxsb3Zlciwge21vZGU6ICduby1jb3JzJ30pO1xuXG5cdFx0XHRcdFx0ZmV0Y2goZnJlcXVlc3QpLnRoZW4ocmVzcG9uc2UgPT4ge1xuXHRcdFx0XHRcdFx0Ly8gSnVzdCB1cGRhdGUgdGhlIGV4aXN0aW5nIHJlY29yZFxuXHRcdFx0XHRcdFx0aWYgKG1hdGNoKSB7XG5cdFx0XHRcdFx0XHRcdG1hdGNoLmZhbGxvdmVyID0gZGF0YS5mYWxsb3Zlcjtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdGVsc2Uge1xuXHRcdFx0XHRcdFx0XHRmYWxsb3ZlclN0b3JlLnB1dChkYXRhKTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdHJldHVybiBjYWNoZS5wdXQoZGF0YS5mYWxsb3ZlciwgcmVzcG9uc2UpO1xuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHR9KTtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHR9XG5cdFx0XHRjYXNlICdhZGQnOiB7XG5cdFx0XHRcdGNvbnN0IHJlcXVlc3QgPSBuZXcgUmVxdWVzdChkYXRhLnVybCwge21vZGU6ICduby1jb3JzJ30pO1xuXHRcdFx0XHRyZXR1cm4gZmV0Y2gocmVxdWVzdCkudGhlbihyZXNwb25zZSA9PiBjYWNoZS5wdXQoZGF0YS51cmwsIHJlc3BvbnNlKSk7XG5cdFx0XHR9XG5cdFx0fVxuXHR9KTtcbn0pO1xuXG5cbiJdfQ=="}